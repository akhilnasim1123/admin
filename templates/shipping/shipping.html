
{% extends 'base.html' %}{% load static %}

{% block content %}
<style>
input [type=text]{
  width: 20%;
  padding: 12px 20px;
  margin: 8px 0;
  border: none;
  box-sizing: border-box;

  border-bottom: 0px  solid red;
}
</style>


 <section class="h-100 h-custom" style="background-color: #eee;">
        <div class="container py-5 h-100">
          <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col">
              <div class="card">
                <div class="card-body py-4 d-flex justify-content-center">
<div class="d-flex ">
                  <div class="row mx-1" style="width: 100%;">

                    <div class="">
                      <h5 class="mb-3"><a href="#!" class="text-body"><i
                            class="fas fa-long-arrow-alt-left me-2"></i>Continue shopping</a></h5>
                      <hr>

                      <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                          <p class="mb-1">Shopping cart</p>
                          <p class="mb-0">You have 4 items in your cart</p>
                        </div>
                        <div>
                          <p class="mb-0"><span class="text-muted">Sort by:</span> <a href="#!"
                              class="text-body">price <i class="fas fa-angle-down mt-1"></i></a></p>
                        </div>
                      </div>
{% for item in items %}
                      <div class="card mb-3">
                        <div class="card-body">
                          <div class="d-flex justify-content-between">
                            <div class="d-flex flex-row align-items-center">
                              <div>
                                <img
                                  src="/media/{{ item.product.image1 }}"
                                  class="img-fluid rounded-3" alt="Shopping item" style="width: 65px;">
                              </div>
                              <div class="ms-3">
                                <h5>{{ item.product.product_name }}</h5>
                                <p class="small mb-0">{{ item.product.category.category_name }}</p>
                              </div>
                            </div>
                            <div class="d-flex flex-row align-items-center">
                              <div style="width: 50px;">
                                <h5 class="fw-normal mb-0">{{ item.quantity }}</h5>
                              </div>
                              <div style="width: 120px;">
                                <h5 class="mb-0">₹{{ item.get_total|floatformat:2 }}/-</h5>
                              </div>
                              <a href="{% url 'deletecart' item.id '2' %} " style="color: #cecece;"><i class="fas fa-trash-alt"></i></a>
                            </div>
                          </div>
                        </div>
                      </div>
 {% endfor %}
 {% if address %}
 
 <div class="mb-3">
  <p><b>Address</b></p>
  <hr>
  {% for i in address %}          
                               <p>
                                    {{i.address}}<br>
                                    {{i.city}},{{i.state}}
                              </p>
                               
                               <input type="radio" id="address" name="address" value="i.id">
                              <hr>
                          {% endfor %}
                        </div>
                          {% endif %}
                          </div>
                            
                            
                    </div>
                    



                    <div class="" style="width: 60%;">

                      <div class="card bg-dark text-white  rounded-3">
                        <div class="card-body h-300">
                          <div class="d-flex justify-content-between align-items-center mb-4">

                          </div>
                             {% if order %}
                  
                          <form class="mt-2" method="post" action="{% url 'pay_page' %}">
                  
                              {% csrf_token %}
                              {% for message in messages %}
                                <h5 class="text-center text-danger">{{ message }}</h5>
                              {% endfor %}
                            <div class="form-outline form-white">
                                  <input name="name" type="text" class="form-control "
                                    placeholder="Name"  maxlength="19" value=""/>

                                </div>

                                <input type="email" value="{{order.account.email}}" name="email" hidden/>


                             <div  class="form-outline form-white mt-2">
                                  <input name="phone" type="tel" class="form-control "
                                    placeholder="Phone Number"  maxlength="19" value=""/>

                                </div>


                            <div class="form-outline form-white mt-2">
                              <input name="address" type="text" id="typeName" class="form-control " siez="17"
                                placeholder="Address" />

                            </div>
                            <div class="form-outline form-white mt-2">
                              <input name="city" type="text" id="typeText" class="form-control form-control-md" siez="17"
                                placeholder="city"  />

                            </div>

                            <div class="row mb-4">
                              <div class="col-md-6">
                                <div class="form-outline form-white mt-2">
                                  <input name="state" type="text" id="typeExp" class="form-control "
                                    placeholder="State"  />
                        
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="form-outline form-white mt-2">
                                  <input name="pincode" type="number" id="typeText" class="form-control "
                                    placeholder="pincode"  maxlength="9" />
                  
                                </div>
                              </div>
                            </div>


                          <button type="submit" class="btn text-white btn-block " style="width: 100%;background-color: #387445">
                            <div class="d-flex justify-content-evenly">
                              <input type="hidden" name="payment_mode" value="COD">
                              <div><span>₹{{ order.get_cart_total|floatformat:2 }}/-</span></div>
      <div> <span>COD Checkout <i class="fas fa-long-arrow-alt-right ms-2"></i></span></div>
                            
                            </div>

                          </button>


                            
                          <button type="button" class="btn mt-2 text-white btn-secondary payWithRazorpay btn-block"  style="width: 100%;">
                            <div class="d-flex justify-content-evenly">

                              <div> <span>RazorPay<i class="fas fa-long-arrow-alt-right  ms-2"></i></span></div>
                            </div>
                          </button>

                          <div class="mt-2">
                          
                          <div  id="paypal-button-container"></div>
                          
                        </div>
                              </form>
                                {% endif %}

                        </div>
                      </div>

                    </div>
                  </div>

                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

{% endblock content %}
{% block scripts %} 
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="https://www.paypal.com/sdk/js?client-id=AU9bfhFhG6kK53IK6MsaXC0jJR6gpKiW1fvkculvVBm6Reb7hra5aQ0rgpBp3kPDQL-9tSta3Tu1RIIe&currency=USD"></script>

<script>

  paypal.Buttons({
    
    // Sets up the transaction when a payment button is clicked
    
    onClick : function(data,actions){
      var name = $("[name='name']").val();
      var phone = $("[name='phone']").val();

      var address = $("[name='address']").val();
      var city = $("[name='city']").val();
      var state = $("[name='state']").val();
      var pincode = $("[name='pincode']").val();
      var token = $("[name='csrfmiddlewaretoken']").val();
  
      if(phone == "" || name == "" || address == "" || city == "" || state == "" || pincode == "")
          {
              swal("Alert!", "All fields are mandatory!","error");
  
              return false;
          }
      else{
              return true;

         }

    },
    
    createOrder: (data, actions) => {
      return actions.order.create({
        purchase_units: [{
          amount: {
            value: '0.01' //'{{ order.get_cart_total|floatformat:2 }}' // Can also reference a variable or function
          }
        }]
      });
    },
    // Finalize the transaction after payer approval
    onApprove: (data, actions) => {
      return actions.order.capture().then(function(orderData) {
        // Successful capture! For dev/demo purposes:
      console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
       alert(orderData.id)
       // const transaction = orderData.purchase_units[0].payments.captures[0];
       // alert(`Transaction ${transaction.status}: ${transaction.id}\n\nSee console for all available details`);
        // When ready to go live, remove the alert and show a success message within this page. For example:
        // const element = document.getElementById('paypal-button-container');
        // element.innerHTML = '<h3>Thank you for your payment!</h3>';
        // Or go to another URL:  actions.redirect('thank_you.html');       
        var name = $("[name='name']").val();
        var phone = $("[name='phone']").val();
  
        var address = $("[name='address']").val();
        var city = $("[name='city']").val();
        var state = $("[name='state']").val();
        var pincode = $("[name='pincode']").val();
        var token = $("[name='csrfmiddlewaretoken']").val();
        
        
        data = {
          "name": name,
          "phone": phone,
          "address": address,
          "city": city,
          "state": state,
          "pincode": pincode,
          "payment_mode":"Paid by Paypal",
          "payment_id":orderData.id,
          csrfmiddlewaretoken:token,
                             }


          $.ajax({
            type: "POST",
            url: "/cart/payment",
            data: data,
            success: function (responsea) {
                swal("Congratulations!", "Your Order is Placed","success").then((value) => {
                    window.location.href = '/'
                  });
              
              
              
          }
      });
      
      
      });
    }
  }).render('#paypal-button-container');
</script>

{% endblock scripts %}